{% extends "base.html" %}
{% comment 'header' %}
# This file is part of opentaps Smart Energy Applications Suite (SEAS).

# opentaps Smart Energy Applications Suite (SEAS) is free software:
# you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# opentaps Smart Energy Applications Suite (SEAS) is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.

# You should have received a copy of the GNU Lesser General Public License
# along with opentaps Smart Energy Applications Suite (SEAS).
# If not, see <https://www.gnu.org/licenses/>.
{% endcomment %}

{% load static %}

{% block title %}UtilityAPI Meter Data Import{% endblock %}

{% block content %}
<div class="container">

  {% include "core/_breadcrumbs.html" %}

  <div class="card mb-3" id="meterdataimport">
    <div class="card-body">
      <h2>UtilityAPI Meter Data Import</h2>
      <br/>
      {% block inner_content %}

      <div class="alert alert-danger mt-3" role="alert" v-if="errors.error">
          ${ errors.error }
      </div>
      <div class="alert alert-success mt-3" role="alert" v-if="successes.success" v-cloak>
        ${ successes.success }
      </div>

      <div class="form-group">
        <label for="customerEmail">Customer Email*</label>
        <b-form-input type="email" id="customerEmail" placeholder="Input Email" :state="customerEmailState" v-model="customerEmail" required></b-form-input>
        <b-form-invalid-feedback id="customerEmail">
            Customer Email is required
        </b-form-invalid-feedback>
      </div>
      <div class="text-right">
        <b-button v-if="!isSearchDisabled" variant="primary" v-on:click.stop.prevent="get_utilityapi_meters()" :disabled="isSearchDisabled">
          <i class="fa fa-search"></i> Search Meters
        </b-button>
        <b-spinner v-if="isSearchDisabled" variant="secondary"></b-spinner>
      </div>

      <div class="mt-3" v-if="meters.length">
          <label for="utilityapiMeter">UtilityAPI Meters</label>
          <select name="utilityapiMeter" class="select form-control" id="id_utilityapiMeter" v-model="selectedMeter">
            <option v-for="c in meters" :value="c.uid">${ c.description }</option>
          </select>
          <div class="mt-3 text-right">
            <b-button variant="primary" v-on:click.stop.prevent="import_utilityapi_meter_data()" :disabled="isImportDisabled">
              <i class="fa fa-plus"></i> Import Data
            </b-button>
            <b-spinner v-if="isImportDisabled" variant="secondary"></b-spinner>
          </div>
      </div>

      {% endblock inner_content %}
    </div>
  </div>
</div>

<script>
(function() {
  {% load js_csrf_token from core_tags %}
  const CSRF_TOKEN = '{% js_csrf_token %}';

  new Vue({
    delimiters: ['${', '}'],
    name: 'meterdataimport',
    el: '#meterdataimport',
    data() {
      return {
        csrfmiddlewaretoken: CSRF_TOKEN,
        customerEmailState: null,
        customerEmail: null,
        isSearchDisabled: false,
        isImportDisabled: false,
        meters: [],
        selectedMeter: null,
        errors: {'error': null},
        successes:  {'success': null},
        meterId: {%if meter_id %}'{{ meter_id|safe}}'{%else%}''{%endif%},
      }
    },

    mounted() {
      console.log('mounted..');
    },
    methods: {
      get_utilityapi_meters() {
          console.log('get_utilityapi_meters..');
          this.customerEmailState = null;
          this.errors = {'error': null};
          if (!this.customerEmail) {
              this.customerEmailState = false;

          } else {
              this.isSearchDisabled = true;
              url = dutils.urls.resolve('utilityapi_meters_json') + '?customer_email=' + this.customerEmail;
              axios.get(url)
                .then(x => {
                  console.log('get_utilityapi_meters', x.data)
                  if (x.data.error) {
                      this.errors['error'] = x.data.error;
                  } else if (!x.data.meters || (x.data.meters && x.data.meters.length == 0)) {
                      this.errors['error'] = 'Cannot find customer UtilityAPI meters.';
                  } else {
                      this.meters = x.data.meters;
                      this.selectedMeter = this.meters[0].uid;
                  }
                  this.isSearchDisabled = false;
                })
                .catch(err => {
                  console.error('loading utility rates error :', err);
                  e = getResponseError(err);
                  this.errors = e;
                  this.isSearchDisabled = false;
                });
          }
      },
      import_utilityapi_meter_data() {
          this.errors = {'error': null};
          this.successes = {'success': null};
          url = dutils.urls.resolve('utilityapi_meter_data_import', { meter_id: this.meterId });
          console.log('import_utilityapi_meter_data: this.selectedMeter', this.selectedMeter)
          console.log('url =', url)
          if (!this.selectedMeter) {
              this.errors = {'error': 'Please, select UtilityAPI Meter.'};
          } else {
              this.isImportDisabled = true;
              data = {meter_uid: this.selectedMeter};
              axios.post(url, data, {headers: {'X-CSRFToken': this.csrfmiddlewaretoken}})
                .then(x => x.data)
                .then(x => {
                  if (x.success) {
                    console.log('import_utilityapi_meter_data, result = ', x);

                    this.successes = {'success': 'Successfully imported UtilityAPI meter data'};
                  }
                  this.isImportDisabled = false;
                })
                .catch(err => {
                  e = getResponseError(err);
                  console.error(e, err);
                  this.errors = e;
                  this.isImportDisabled = false;
                });
          }
      }
    }
  });
})();
</script>

{% endblock content %}
